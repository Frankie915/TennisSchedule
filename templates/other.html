{% extends 'index.html' %}

{% block title %}Other Data{% endblock %}

{% block content %}

    <div class="container">
        <br>
        <h3>Other Data</h3>
        <h5>Plays At</h5>
        <form action="{{url_for('addPlaysAt')}}" method="POST">
            <table class="table table-bordered blackBorder">
                <thead>
                    <td>Player</td>
                    <td>Stadium</td>
                    <td>Edit</td>
                    <td>Delete</td>
                </thead>
                    
                {% for row in playsAt %}
                    <tr>
                    <td>{{row['name']}}</td>
                    <td>{{row['stadiumName']}}</td>
                    <td><button onclick="editRow(this, '{{row['playerID']}}-{{row['stadiumName']}}', {{ players }}, {{ tournaments }}, {{ stadiums }}, '{{'playsAt'}}')" class="btn btn-secondary"><i class="bi bi-pencil"></i></button></td>
                    <td><a href="/deletePlaysAt/{{row['playerID']}}-{{row['stadiumName']}}" class="btn btn-danger"><i class="bi bi-trash3"></i></a></td>
                    </tr>
                {% endfor %}
                <tr>
                    <td>
                        <select name="player" id="player-select" required>
                           <option selected value="">Player</option>
                           {% for row in players %}
                                <option value="{{row['playerID']}}">{{row['name']}}</option>
                           {% endfor %}
                        </select>
                    </td>
                    <td>
                        <select name="stadium" id="stadium-select" required>
                           <option disabled selected value="">Stadium</option>
                           {% for row in stadiums %}
                                <option value="{{row['stadiumName']}}">{{row['stadiumName']}}</option>
                           {% endfor %}
                        </select>
                    </td>
                    <td></td>
                    <td></td>
                </tr>
            </table>
            <input class="btn btn-primary" type="submit" value="Add">
        </form>
        <br>

        <h5>Hosted At</h5>
        <form action="{{url_for('addHostedAt')}}" method="POST">
            <table class="table table-bordered blackBorder">
                <thead>
                    <td>Tournament</td>
                    <td>Stadium</td>
                    <td>Edit</td>
                    <td>Delete</td>
                </thead>
                    
                {% for row in hostedAt %}
                    <tr>
                    <td>{{row['tournamentName']}}</td>
                    <td>{{row['stadiumName']}}</td>
                    <td><button onclick="editRow(this, '{{row['tournamentName']}}-{{row['stadiumName']}}', {{ players }}, {{ tournaments }}, {{ stadiums }}, '{{'hostedAt'}}')" class="btn btn-secondary"><i class="bi bi-pencil"></i></button></td>
                    <td><a href="/deleteHostedAt/{{row['tournamentName']}}-{{row['stadiumName']}}" class="btn btn-danger"><i class="bi bi-trash3"></i></a></td>
                    </tr>
                {% endfor %}
                <tr>
                    <td>
                        <select name="tournament" id="tournament-select" required>
                           <option disabled selected value="">Tournament</option>
                           {% for row in tournaments %}
                                <option value="{{row['tournamentName']}}">{{row['tournamentName']}}</option>
                           {% endfor %}
                        </select>
                    </td>
                    <td>
                        <select name="stadium" id="stadium-select" required>
                           <option disabled selected value="">Stadium</option>
                           {% for row in stadiums %}
                                <option value="{{row['stadiumName']}}">{{row['stadiumName']}}</option>
                           {% endfor %}
                        </select>
                    </td>
                    <td></td>
                    <td></td>
                </tr>
            </table>
            <input class="btn btn-primary" type="submit" value="Add">
        </form>
        <br>

        <h5>Competes In</h5>
        <form action="{{url_for('addCompetesIn')}}" method="POST">
            <table class="table table-bordered blackBorder">
                <thead>
                    <td>Player</td>
                    <td>Tournament</td>
                    <td>Wins</td>
                    <td>Edit</td>
                    <td>Delete</td>
                </thead>
                    
                {% for row in competesIn %}
                    <tr>
                    <td>{{row['name']}}</td>
                    <td>{{row['tournamentName']}}</td>
                    <td>{{row['wins']}}</td>
                    <td><button onclick="editRow(this, '{{row['playerID']}}-{{row['tournamentName']}}', {{ players }}, {{ tournaments }}, {{ stadiums }}, '{{'competesIn'}}')" class="btn btn-secondary"><i class="bi bi-pencil"></i></button></td>
                    <td><a href="/deleteCompetesIn/{{row['playerID']}}-{{row['tournamentName']}}" class="btn btn-danger"><i class="bi bi-trash3"></i></a></td>
                    </tr>
                {% endfor %}
                <tr>
                    <td>
                        <select name="player" id="player-select" required>
                           <option disabled selected value="">Player</option>
                           {% for row in players %}
                                <option value="{{row['playerID']}}">{{row['name']}}</option>
                           {% endfor %}
                        </select>
                    </td>
                    <td>
                        <select name="tournament" id="tournament-select" required>
                           <option disabled selected value="">Tournament</option>
                           {% for row in tournaments %}
                                <option value="{{row['tournamentName']}}">{{row['tournamentName']}}</option>
                           {% endfor %}
                        </select>
                    </td>
                    <td><input type="number" name="wins" placeholder="wins" required></input></td>
                    <td></td>
                    <td></td>
                </tr>
            </table>
            <input class="btn btn-primary" type="submit" value="Add">
        </form>
    </div>

    <script>
        function editRow(button, id, players, tournaments, stadiums, table) {
            console.log(table);
            var form = button.closest('form');
            var row = button.closest('tr');
            var cells = row.querySelectorAll('td:not(:last-child)'); // Exclude the last two cells (Edit/Delete buttons)
            var selectOptions = {}; // to store original select options
        
            cells.forEach(function(cell, index) {
                if (index >= 0 && index < cells.length - 1) {
                    var cellText = cell.textContent;
                    // create input element
                    var input;
                    if (index === 0) {
                        input = document.createElement('select');
                        var options = cell.querySelectorAll('option');
                        if (table === "competesIn" || table === "playsAt") {
                            players.forEach(function(player) {
                                var newOption = document.createElement('option');
                                newOption.value = player.playerID;
                                newOption.text = player.name;
                                input.appendChild(newOption);
                            });
                        }
                        else {
                            tournaments.forEach(function(tournament) {
                                var newOption = document.createElement('option');
                                newOption.value = tournament.tournamentName;
                                newOption.text = tournament.tournamentName;
                                input.appendChild(newOption);
                            }); 
                        }
                        selectOptions[index] = cellText;
                    } else if (index === 1) {
                        input = document.createElement('select');
                        var options = cell.querySelectorAll('option');
                        if (table === "competesIn") {
                            tournaments.forEach(function(tournament) {
                                var newOption = document.createElement('option');
                                newOption.value = tournament.tournamentName;
                                newOption.text = tournament.tournamentName;
                                input.appendChild(newOption);
                            });
                        } else {
                            stadiums.forEach(function(stadium) {
                                var newOption = document.createElement('option');
                                newOption.value = stadium.stadiumName;
                                newOption.text = stadium.stadiumName;
                                input.appendChild(newOption);
                            });
                        }
                    } else {
                        input = document.createElement('input');
                        input.type = 'text';
                        input.value = cellText;
                    }
                    cell.innerHTML = ''; // clear the cell
                    cell.appendChild(input); // add the input element
                }
            });
        
            // Update the button to a save button
            button.innerHTML = '<i class="bi bi-save"></i>';
            button.setAttribute('onclick', `saveRow(this, '${id}')`);
        }
    
        function saveRow(button, id) {
            var form = button.closest('form');
            var row = button.closest('tr');
            var inputs = row.querySelectorAll('input, select');
            var data = { id: id };
        
            inputs.forEach(function(input, index) {
                if (index > 0) {
                    var cell = input.parentNode;
                    var newValue = input.value;
                    if (input.nodeName === 'SELECT') {
                        newValue = input.options[input.selectedIndex].text;
                    }
                    cell.textContent = newValue;
                    data[input.name] = input.value;
                }
            });
    
            // Send data to the server using Fetch API
            fetch(form.getAttribute('action'), {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(data),
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                return response.json();
            })
            .then(data => {
                // Handle success response from the server if needed
                console.log(data);
            })
            .catch(error => {
                // Handle error from the server or network error
                console.error('There was a problem with the fetch operation:', error);
            });
    
            // Revert the save button back to an edit button
            button.innerHTML = '<i class="bi bi-pencil"></i>';
            button.setAttribute('onclick', `editRow(this, '${id}')`);
        }
    </script>

{% endblock %}
